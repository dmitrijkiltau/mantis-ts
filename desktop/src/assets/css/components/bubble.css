@layer components {
  .speech-bubble {
    @apply relative rounded-xl p-6 max-w-2xl bg-bg-bubble border-2 border-terminal-primary;
    @apply flex flex-col;
    box-shadow: var(--shadow-glow-primary-soft), var(--shadow-inset-glow);
    animation: bubble-appear 0.4s ease-out;
    max-height: min(60vh, 520px);
    overflow: hidden;

    &.hidden {
      @apply hidden;
    }
  }

  .bubble-content {
    @apply text-base leading-relaxed text-terminal-primary font-mono;
    white-space: pre-wrap;
    word-wrap: break-word;
    @apply pr-2;
    max-height: min(50vh, 420px);
    overflow-y: auto;

    p {
      margin: 0.5em 0;

      &:first-child {
        margin-top: 0;
      }

      &:last-child {
        margin-bottom: 0;
      }
    }

    ul, ol {
      margin: 0.5em 0;
      padding-left: 1.5em;
    }

    strong {
      font-weight: 700;
      color: var(--color-primary);
    }

    em {
      font-style: italic;
    }

    a {
      color: var(--color-primary);
      text-decoration: underline;

      &:hover {
        color: var(--color-primary-70);
      }
    }

    &::-webkit-scrollbar {
      @apply w-2;
    }

    &::-webkit-scrollbar-track {
      background: var(--color-bg-black-soft);
    }

    &::-webkit-scrollbar-thumb {
      @apply rounded;
      background: var(--color-primary-40);

      &:hover {
        background: var(--color-primary-60);
      }
    }

    .inline-code {
      @apply px-1 py-0.5 rounded border text-sm;
      background: var(--color-primary-10);
      border-color: var(--color-primary-30);
      color: var(--color-terminal-cyan);
    }

    .code-block {
      @apply flex flex-col rounded border overflow-hidden;
      background: var(--color-bg-black);
      border-color: var(--color-primary-30);
      box-shadow: var(--shadow-inset-glow);
    }

    .code-block-header {
      @apply flex items-center justify-between px-3 py-2 text-[11px] font-bold tracking-widest;
      background: var(--color-primary-10);
      border-bottom: 1px solid var(--color-primary-30);
    }

    .code-block-lang {
      @apply text-terminal-cyan;
    }

    .code-block pre {
      @apply m-0 p-3 text-xs overflow-x-auto;
      white-space: pre;
    }

    .code-block code {
      @apply font-mono text-terminal-primary;
    }

    .token-keyword {
      color: var(--color-terminal-cyan);
      font-weight: 600;
    }

    .token-string {
      color: var(--color-terminal-amber);
    }

    .token-number {
      color: var(--color-terminal-emerald);
    }

    .token-comment {
      color: var(--color-primary-60);
      font-style: italic;
    }

    .token-constant {
      color: var(--color-terminal-orange);
      font-weight: 600;
    }

    .file-preview {
      @apply flex flex-col gap-3;
    }

    .file-preview-header {
      @apply flex flex-wrap items-center gap-3 text-xs font-bold tracking-widest;
      color: var(--color-primary-70);
    }

    .file-preview-label {
      @apply px-2 py-1 rounded border text-[10px];
      border-color: var(--color-primary-40);
      color: var(--color-terminal-cyan);
      background: var(--color-primary-10);
    }

    .file-preview-path {
      @apply text-[11px] font-mono;
      color: var(--color-terminal-primary);
    }

    .file-tree {
      @apply rounded border p-3;
      background: var(--color-bg-terminal);
      border-color: var(--color-primary-30);
      box-shadow: var(--shadow-inset-glow);
    }

    .file-tree-header {
      @apply flex flex-col gap-1 mb-3 text-xs;
    }

    .file-tree-title {
      @apply text-terminal-cyan font-bold tracking-widest;
    }

    .file-tree-path {
      @apply text-[11px] font-mono;
      color: var(--color-primary-70);
    }

    .file-tree-meta {
      @apply text-[11px] font-mono;
      color: var(--color-primary-70);
    }

    .file-tree-warning {
      @apply text-[10px] font-bold tracking-widest;
      color: var(--color-terminal-amber);
    }

    .file-tree-list {
      @apply flex flex-col gap-1;
    }

    .file-tree-row {
      @apply flex items-start gap-2 text-sm;
      padding-left: calc(var(--depth, 0) * 1.25rem);
    }

    .file-node-badge {
      @apply text-[10px] font-bold uppercase border px-2 py-0.5 rounded;
      border-color: var(--color-primary-40);
      color: var(--color-terminal-primary);
      background: var(--color-primary-10);

      &[data-kind='folder'] {
        color: var(--color-terminal-cyan);
        border-color: var(--color-cyan-40);
        background: var(--color-cyan-20);
      }

      &[data-kind='file'] {
        color: var(--color-terminal-emerald);
        border-color: var(--color-emerald-40);
        background: var(--color-emerald-20);
      }

      &[data-kind='other'] {
        color: var(--color-terminal-orange);
        border-color: var(--color-primary-40);
        background: var(--color-primary-10);
      }
    }

    .file-node-info {
      @apply flex flex-col gap-1;
    }

    .file-node-name {
      @apply text-terminal-primary;
    }

    .file-node-path {
      @apply text-[11px] font-mono;
      color: var(--color-primary-70);
      word-break: break-all;
    }
  }

  .bubble-tail {
    @apply w-0 h-0 absolute -top-5 left-1/2 transform -translate-x-1/2 rotate-180;
    @apply border-l-15 border-r-15 border-b-20 border-b-terminal-primary;
    filter: drop-shadow(0 2px 4px var(--color-primary-30));
  }

  @keyframes bubble-appear {
    from {
      opacity: 0;
      transform: translateY(-10px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }
}
